services:
  gipsum-db:
    image: postgres:15
    volumes:
      - ./data/db:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=gipsum_db
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
    ports:
      - "5432:5432"
    networks:
      - traefik
      - bridge
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  server-gipsum:
    container_name: django_app
    build:
      context: .
      dockerfile: .docker/.django/Dockerfile
    command: >
      sh -c "python manage.py migrate &&
             python manage.py runserver 0.0.0.0:5000"
    # command: /bin/bash -c "tail -f /dev/null" # для отладки
    volumes:
      - ./backend:/code
      - ./data/media:/code/media  # Для загружаемых файлов
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api-gipsum-django.rule=Host(`api.gipsum.docker`)"
      - "traefik.docker.network=${TRAEFIK_NETWORK_NAME}"
      - "traefik.http.routers.api-gipsum-django.tls=true"
    environment:
      - DEBUG=True
      - SECRET_KEY=your-secret-key-change-in-production
      - DB_NAME=gipsum_db
      - DB_USER=postgres
      - DB_PASSWORD=postgres
      - DB_HOST=gipsum-db
      - DB_PORT=5432
      - ALLOWED_HOSTS=api-gipsum.docker,localhost,127.0.0.1
      - CORS_ALLOWED_ORIGINS=http://gipsum.docker,https://gipsum.docker,localhost,127.0.0.1
      # Email settings
      - EMAIL_BACKEND=django.core.mail.backends.console.EmailBackend  # Для разработки
      # - EMAIL_BACKEND=django.core.mail.backends.smtp.EmailBackend  # Для продакшена
      # - EMAIL_HOST=smtp.gmail.com
      # - EMAIL_PORT=587
      # - EMAIL_USE_TLS=True
      # - EMAIL_HOST_USER=your-email@gmail.com
      # - EMAIL_HOST_PASSWORD=your-app-password
      # - DEFAULT_FROM_EMAIL=Gipsum Shop <noreply@gipsum.shop>
      # - ADMIN_EMAILS=admin@example.com,manager@example.com
    depends_on:
      gipsum-db:
        condition: service_healthy
    networks:
      - traefik
      - bridge

  node-gipsum:
    container_name: nuxt_app
    build:
      context: .
      dockerfile: .docker/npm/Dockerfile
      target: dev
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.gipsum-nuxt.rule=Host(`gipsum.docker`)"
      - "traefik.docker.network=${TRAEFIK_NETWORK_NAME}"
      - "traefik.http.routers.gipsum-nuxt.tls=true"
    volumes:
      - ./frontend:/usr/src/app
    environment:
      - ALLOWED_HOSTS=gipsum.docker,localhost,127.0.0.1
      - CORS_ALLOWED_ORIGINS=http://api-gipsum.docker,https://api-gipsum.docker
    networks:
      - traefik
      - bridge
    # ports:
    #   - "3000:3000"

networks:
  bridge: ~
  traefik:
    external: true
    name: ${TRAEFIK_NETWORK_NAME}